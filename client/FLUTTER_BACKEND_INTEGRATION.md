# Flutter Backend Integration Guide

## Overview

Complete API documentation for the PocketCoder backend. This reflects the actual implementation as of the current codebase.

**Base URL:** `http://pocketbase:8090` (container) or `http://localhost:8090` (local)
**Auth:** Bearer token (JWT) from PocketBase auth system

---

## 1. Authentication

### Login
```
POST /api/collections/users/auth-with-password
Content-Type: application/json

{
  "identity": "email@example.com",
  "password": "password"
}

Response:
{
  "record": {
    "id": "user_id",
    "email": "email@example.com",
    "role": "admin|agent|user",
    "created": "2026-02-17T...",
    "updated": "2026-02-17T..."
  },
  "token": "jwt_token_here"
}
```

### Refresh Token
```
POST /api/collections/users/auth-refresh
Authorization: Bearer {token}

Response:
{
  "record": { /* user record */ },
  "token": "new_jwt_token"
}
```

### Get Current User
```
GET /api/collections/users/auth-self
Authorization: Bearer {token}

Response:
{
  "id": "user_id",
  "email": "email@example.com",
  "role": "admin|agent|user",
  "created": "2026-02-17T...",
  "updated": "2026-02-17T..."
}
```

### User Roles
- `admin` - Full access to all collections and admin features
- `agent` - Can view all chats, update messages, manage agents
- `user` - Can only access own chats and SSH keys

---

## 2. Standard CRUD Operations

All collections support standard PocketBase REST operations.

### List Records
```
GET /api/collections/{collection}/records?page=1&perPage=30&sort=-created&filter=...
Authorization: Bearer {token}

Response:
{
  "page": 1,
  "perPage": 30,
  "totalItems": 100,
  "totalPages": 4,
  "items": [ /* records */ ]
}
```

### Get Single Record
```
GET /api/collections/{collection}/records/{id}
Authorization: Bearer {token}

Response: { /* record */ }
```

### Create Record
```
POST /api/collections/{collection}/records
Authorization: Bearer {token}
Content-Type: application/json

{ /* fields */ }

Response: { /* created record */ }
```

### Update Record
```
PATCH /api/collections/{collection}/records/{id}
Authorization: Bearer {token}
Content-Type: application/json

{ /* fields */ }

Response: { /* updated record */ }
```

### Delete Record
```
DELETE /api/collections/{collection}/records/{id}
Authorization: Bearer {token}

Response: 204 No Content
```

---

## 3. Collections Reference

### users
**ID:** `users` (PocketBase built-in, enhanced)

**Fields:**
| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `id` | string | auto | |
| `email` | string | yes | Unique |
| `password` | string | yes | Hashed |
| `role` | select | no | "admin", "agent", "user" |
| `created` | date | auto | |
| `updated` | date | auto | |

**Rules:**
- List: All authenticated users
- View: Owner or admin/agent
- Create: Admin only (via admin UI)
- Update: Owner or admin
- Delete: Admin only

---

### ai_models
**ID:** `pc_ai_models`

**Fields:**
| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `id` | string | auto | |
| `name` | string | yes | Display name |
| `identifier` | string | yes | API identifier (e.g., "gpt-4", "claude-3-opus-20241120") |
| `created` | date | auto | |
| `updated` | date | auto | |

**Rules:**
- List/View/Create/Update/Delete: All authenticated users

---

### ai_prompts
**ID:** `pc_ai_prompts`

**Fields:**
| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `id` | string | auto | |
| `name` | string | yes | |
| `body` | string | yes | System prompt text |
| `created` | date | auto | |
| `updated` | date | auto | |

**Rules:**
- List/View/Create/Update/Delete: All authenticated users

---

### ai_agents
**ID:** `pc_ai_agents`

**Fields:**
| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `id` | string | auto | |
| `name` | string | yes | Unique agent name |
| `is_init` | bool | no | Is this the main/initial agent? |
| `prompt` | relation | no | Links to ai_prompts (max 1) |
| `model` | relation | no | Links to ai_models (max 1) |
| `config` | string | no | Auto-generated YAML bundle |
| `created` | date | auto | |
| `updated` | date | auto | |

**Rules:**
- List/View: All authenticated users
- Create/Update/Delete: Admin only (typically managed via admin UI)

**Note:** The `config` field is auto-generated by the backend bundler from prompt + model + permission rules. Do not manually set it.

---

### chats
**ID:** `pc_chats`

**Fields:**
| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `id` | string | auto | |
| `title` | string | yes | |
| `agent_id` | string | no | OpenCode session ID (NOT a relation) |
| `user` | relation | yes | Links to users |
| `agent` | relation | no | Links to ai_agents |
| `last_active` | date | auto | |
| `preview` | string | no | Last message preview (truncated) |
| `turn` | select | no | "user" or "assistant" |
| `created` | date | auto | |
| `updated` | date | auto | |

**Rules:**
- List/View: Owner OR admin/agent
- Create: All authenticated users
- Update: Owner OR admin/agent
- Delete: Owner OR admin

**Expandable:** `user`, `agent`, `messages`

---

### messages
**ID:** `pc_messages`

**Fields:**
| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `id` | string | auto | |
| `chat` | relation | yes | Links to chats |
| `role` | select | yes | "user", "assistant", "system" |
| `status` | select | no | "processing", "completed", "failed", "aborted" |
| `delivery` | select | no | "draft", "pending", "sending", "sent", "failed" |
| `agent_message_id` | string | no | OpenCode message ID |
| `parent_id` | string | no | Parent message ID for threading |
| `agent` | string | no | Agent name from OpenCode |
| `provider_id` | string | no | Provider identifier |
| `model_id` | string | no | Model used |
| `cost` | number | no | Token cost |
| `tokens` | json | no | `{prompt: N, completion: N, reasoning: N}` |
| `error` | json | no | Error details if failed |
| `finish_reason` | string | no | Why message ended |
| `parts` | json | no | Message content/parts array |
| `metadata` | json | no | Custom metadata |
| `created` | date | auto | |
| `updated` | date | auto | |

**Rules:**
- List/View: Owner OR admin/agent
- Create: All authenticated users
- Update: Admin/agent only
- Delete: Admin only

**Message Parts Structure:**
```json
[
  {
    "type": "text",
    "text": "Hello, how can I help?"
  },
  {
    "type": "tool",
    "tool": "bash",
    "state": {
      "output": "file created"
    }
  }
]
```

---

### permissions
**ID:** `pc_permissions`

**Fields:**
| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `id` | string | auto | |
| `agent_permission_id` | string | yes | OpenCode permission ID |
| `session_id` | string | yes | Session identifier |
| `permission` | string | yes | Permission type (e.g., "file_write", "bash") |
| `patterns` | json | no | Pattern array for matching |
| `metadata` | json | no | Additional context |
| `status` | select | yes | "draft", "authorized", "denied" |
| `message` | string | no | Human-readable message |
| `source` | string | no | Where request came from |
| `message_id` | string | no | Related message ID |
| `call_id` | string | no | Related call ID |
| `challenge` | string | no | Challenge token for verification |
| `chat` | relation | no | Links to chats |
| `usage` | relation | no | Links to usages |
| `created` | date | auto | |
| `updated` | date | auto | |

**Rules:**
- List/View: All authenticated users
- Create: Relay service only (internal)
- Update: Owner (if draft) OR admin/agent
- Delete: Admin only

**Status Flow:**
- `draft` → Gated, awaiting user decision
- `authorized` → Auto-replied to OpenCode
- `denied` → User rejected

---

### usages
**ID:** `pc_usages`

**Fields:**
| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `id` | string | auto | |
| `message_id` | string | no | Related message ID |
| `part_id` | string | no | Message part ID |
| `model` | string | no | Model used |
| `tokens_prompt` | number | no | Prompt tokens |
| `tokens_completion` | number | no | Completion tokens |
| `tokens_reasoning` | number | no | Reasoning tokens |
| `cost` | number | no | Monetary cost |
| `status` | select | yes | "in-progress", "completed", "error" |
| `created` | date | auto | |
| `updated` | date | auto | |

**Rules:**
- List/View: All authenticated users
- Create/Update: Admin/agent only

---

### ssh_keys
**ID:** `pc_ssh_keys`

**Fields:**
| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `id` | string | auto | |
| `user` | relation | yes | Links to users |
| `public_key` | string | yes | SSH public key |
| `device_name` | string | no | Device identifier |
| `fingerprint` | string | yes | Key fingerprint |
| `last_used` | date | no | |
| `is_active` | bool | no | Default: true |
| `created` | date | auto | |
| `updated` | date | auto | |

**Rules:**
- List/View: Owner only
- Create/Update/Delete: Owner only

---

### whitelist_targets
**ID:** `pc_whitelist_targets`

**Fields:**
| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `id` | string | auto | |
| `name` | string | yes | Display name |
| `pattern` | string | yes | Glob pattern (e.g., "/workspace/src/**") |
| `active` | bool | no | Default: true |
| `created` | date | auto | |
| `updated` | date | auto | |

**Rules:**
- List/View: All authenticated users
- Create/Update/Delete: Admin only

---

### whitelist_actions
**ID:** `pc_whitelist_actions`

**Fields:**
| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `id` | string | auto | |
| `permission` | string | yes | Permission type (e.g., "file_write", "bash") |
| `kind` | select | no | "strict" or "pattern" |
| `value` | string | no | Pattern value or command ID |
| `active` | bool | no | Default: true |
| `created` | date | auto | |
| `updated` | date | auto | |

**Rules:**
- List/View: All authenticated users
- Create/Update/Delete: Admin only

**Usage:**
- `kind: "pattern"`, `value: "*"` → Allow all paths for this permission
- `kind: "pattern"`, `value: "/workspace/src/**"` → Allow only src directory
- `kind: "strict"`, `value: "cmd_id"` → Allow specific command (for bash)

---

### proposals
**ID:** `pc_proposals`

**Fields:**
| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `id` | string | auto | |
| `name` | string | yes | Unique SOP name |
| `description` | string | no | |
| `content` | string | yes | Markdown content |
| `authored_by` | select | no | "human" or "poco" |
| `status` | select | no | "draft" or "approved" |
| `created` | date | auto | |
| `updated` | date | auto | |

**Rules:**
- List/View: All authenticated users
- Create/Update: All authenticated users
- Delete: Owner OR admin

**Workflow:**
1. Create proposal with `status: "draft"`
2. Review and approve via admin UI
3. Backend automatically seals approved proposals to `sops` collection

---

### sops
**ID:** `pc_sops`

**Fields:**
| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `id` | string | auto | |
| `name` | string | yes | Unique SOP name |
| `description` | string | no | |
| `content` | string | yes | Markdown content |
| `signature` | string | no | SHA256 hash of content |
| `approved_at` | date | no | When approved |
| `created` | date | auto | |
| `updated` | date | auto | |

**Rules:**
- List/View: All authenticated users
- Create: Backend only (via proposal approval)
- Update/Delete: Admin only

**Note:** Created automatically when a proposal is approved. Do not create directly.

---

### subagents
**ID:** `pc_subagents`

**Fields:**
| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `id` | string | auto | |
| `subagent_id` | string | yes | Unique OpenCode subagent ID |
| `delegating_agent_id` | string | yes | Parent agent's OpenCode session ID |
| `tmux_window_id` | number | no | Tmux window for execution |

**Rules:**
- List/View: All authenticated users
- Create: Backend only (via relay service)
- Update/Delete: Admin only

**Note:** Created automatically when OpenCode spawns a subagent via handoff.

---

### healthchecks
**ID:** `healthchecks`

**Fields:**
| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `id` | string | auto | |
| `name` | string | yes | Service name (e.g., "opencode") |
| `status` | string | no | "ready", "offline", etc. |
| `last_ping` | date | no | Last heartbeat |
| `created` | date | auto | |
| `updated` | date | auto | |

**Rules:**
- List/View: All authenticated users
- Create/Update: Backend only (via relay service)

---

## 4. Custom API Endpoints

### Permission Evaluation
```
POST /api/pocketcoder/permission
Authorization: Bearer {token}
Content-Type: application/json

Request:
{
  "permission": "file_write",
  "patterns": ["/workspace/src/**"],
  "chat_id": "chat_id",
  "session_id": "session_id",
  "opencode_id": "agent_permission_id",
  "metadata": { /* context */ },
  "message": "User is requesting to write to /workspace/src/main.rs",
  "message_id": "msg_id",
  "call_id": "call_id"
}

Response:
{
  "permitted": true,
  "id": "permission_record_id",
  "status": "authorized"
}
```

**Purpose:** Submit permission request for evaluation. Creates audit record. Auto-responds if whitelisted.

---

### SSH Keys Sync
```
GET /api/pocketcoder/ssh_keys
Authorization: Bearer {token}

Response:
ssh-rsa AAAAB3NzaC1yc2E... user@device1
ssh-rsa AAAAB3NzaC1yc2E... user@device2
```

**Purpose:** Get all active SSH public keys as newline-separated list for authorized_keys.

---



### Artifact/File Access
```
GET /api/pocketcoder/artifact/{path}
Authorization: Bearer {token}

Response: File content (binary or text)

Errors:
- 400: Empty path
- 403: Path escape attempt or unauthorized
- 404: Artifact not found
- 500: Storage failure
```

**Purpose:** Secure read-only access to workspace files. Prevents path traversal.

**Supported Content Types:**
- `.html` → `text/html`
- `.png` → `image/png`
- `.txt` → `text/plain`
- Others → `application/octet-stream`

---

## 5. Real-Time Events (SSE)

The relay service provides Server-Sent Events at `http://opencode:3000/event`.

**Event Types:**

| Event | Properties | Action |
|-------|------------|--------|
| `server.heartbeat` | - | Updates healthchecks, watchdog |
| `permission.asked` | `id`, `permission`, `sessionID`, `patterns`, `message` | Creates permission record |
| `message.updated` | `info` (role, id, parts, etc.) | Syncs assistant message |
| `message.part.updated` | `part` (sessionID, messageID) | Triggers message sync |
| `session.idle` | `id` | Flips turn back to user |
| `session.updated` | `id`, `status` | Handles session state changes |

**Note:** Flutter client would need to connect to OpenCode's SSE directly for real-time updates. The backend doesn't proxy SSE to clients.

---

## 6. Error Handling

### HTTP Status Codes
- `200 OK` - Success
- `201 Created` - Resource created
- `204 No Content` - Deleted successfully
- `400 Bad Request` - Invalid input
- `401 Unauthorized` - Missing/invalid token
- `403 Forbidden` - Insufficient permissions
- `404 Not Found` - Resource not found
- `500 Internal Server Error` - Server error

### Error Response Format
```json
{
  "error": "error message",
  "code": "error_code"
}
```

---

## 7. Pagination & Filtering

### Pagination
```
GET /api/collections/{collection}/records?page=1&perPage=30
```

**Parameters:**
- `page`: Page number (default: 1)
- `perPage`: Records per page (default: 30, max: 500)

### Filtering
```
GET /api/collections/{collection}/records?filter=(field='value')
```

**Examples:**
- `filter=(status='completed')`
- `filter=(created>='2026-02-01')`
- `filter=(user='{user_id}' && status='draft')`
- `filter=(chat='{chat_id}')`

### Sorting
```
GET /api/collections/{collection}/records?sort=-created,name
```

- Prefix with `-` for descending
- Comma-separated for multiple fields

### Expanding Relations
```
GET /api/collections/chats/records/{id}?expand=messages,user
```

Returns nested related records.

---

## 8. Collection Relationships

```
users (1) ──────── (N) chats
                        │
                        ├── (N) messages
                        │         │
                        │         └── (N) permissions
                        │
                        └── (N) subagents (via delegating_agent_id)

users (1) ──────── (N) ssh_keys

ai_models (1) ──── (N) ai_agents
                       │
ai_prompts (1) ──── (N) ai_agents

chats (1) ──────── (N) permissions
chats (1) ──────── (N) usages

whitelist_targets (N) ──── (N) permission checks
whitelist_actions (N) ──── (N) permission checks

proposals (1) ──── (1) sops (via approval)
```

---

## 9. Quick Reference

| Operation | Endpoint | Method | Auth Required |
|-----------|----------|--------|---------------|
| Login | `/api/collections/users/auth-with-password` | POST | No |
| Refresh | `/api/collections/users/auth-refresh` | POST | Yes |
| Get User | `/api/collections/users/auth-self` | GET | Yes |
| List Records | `/api/collections/{collection}/records` | GET | Yes |
| Get Record | `/api/collections/{collection}/records/{id}` | GET | Yes |
| Create Record | `/api/collections/{collection}/records` | POST | Yes |
| Update Record | `/api/collections/{collection}/records/{id}` | PATCH | Yes |
| Delete Record | `/api/collections/{collection}/records/{id}` | DELETE | Yes |
| Evaluate Permission | `/api/pocketcoder/permission` | POST | Yes |
| Get SSH Keys | `/api/pocketcoder/ssh_keys` | GET | Yes |
| Get Artifact | `/api/pocketcoder/artifact/{path}` | GET | Yes |

---

## 10. Flutter Implementation Notes

### Recommended Libraries
- `pocketbase` - Official Dart SDK (supports auth, CRUD, realtime)
- `http` - For custom endpoints
- `flutter_secure_storage` - Token storage
- `provider` or `riverpod` - State management

### Token Management
```dart
// Store token after login
await secureStorage.write(key: 'pb_token', value: token);

// Include in requests
final authHeader = 'Bearer $token';
```

### Real-Time Subscriptions
```dart
// Subscribe to chat updates
await pb.collection('chats').subscribe('*', (e) {
  // Handle create, update, delete
});
```

### Error Handling
```dart
try {
  await pb.collection('messages').getList(1, 50);
} on ClientException catch (e) {
  // Handle 400, 401, 403, 404, 500
}
```

### Pagination
```dart
final result = await pb.collection('messages').getList(
  page,
  perPage,
  filter: 'chat = "chat_id"',
  sort: '-created',
);
```

---

## 11. Known Issues / Gotchas

1. **Field Naming:** Backend uses `agent_id` (not `opencode_id`) on chats, `agent_message_id` on messages, `agent_permission_id` on permissions

2. **Subagents Schema:** Uses `delegating_agent_id` (string) instead of relation to chats

3. **Auto-Generated Fields:** Don't manually set `config` on ai_agents, `signature` on sops, `challenge` on permissions

4. **SSH Keys:** The `/api/pocketcoder/ssh_keys` endpoint returns raw SSH keys, not JSON

5. **Artifacts:** Only supports read operations, no write endpoint

6. **Real-Time:** PocketBase realtime works for DB changes, but OpenCode SSE events require separate connection

---

## 12. Testing Endpoints

```bash
# Login
curl -X POST http://localhost:8090/api/collections/users/auth-with-password \
  -H "Content-Type: application/json" \
  -d '{"identity": "admin@example.com", "password": "password"}'

# List chats
curl http://localhost:8090/api/collections/chats/records \
  -H "Authorization: Bearer {token}"

# Get SSH keys
curl http://localhost:8090/api/pocketcoder/ssh_keys \
  -H "Authorization: Bearer {token}"
```