name: pocketcoder_workspace
publish_to: none

environment:
  sdk: '>=3.5.0 <4.0.0'

workspace:
  - packages/pocketcoder_flutter
  - packages/app
  - apps/foss
  - apps/app

dev_dependencies:
  melos: ^7.4.0

melos:
  name: pocketcoder_workspace
  
  scripts:
    build_all:
      run: melos run build_gen --no-select
      description: Run build_runner for all packages.
    
    build_gen:
      run: flutter pub run build_runner build --delete-conflicting-outputs
      exec:
        concurrency: 1
      packageFilters:
        dependsOn: build_runner

    build_foss:
      run: |
        cd apps/foss && flutter build apk --debug
      description: Build the FOSS version (pocketcoder_foss).

    build_app:
      run: |
        cd apps/app && flutter build apk --debug
      description: Build the App Store version (pocketcoder_app).

    run_app:
      run: |
        cd apps/app && flutter run
      description: Run the App Store (Pro) version.

    run_foss:
      run: |
        cd apps/foss && flutter run
      description: Run the FOSS version.

    run_incognito:
      run: |
        cd apps/app && flutter run -d chrome --web-browser-flag="--incognito" --dart-define=SKIP_AUTH=true
      description: Run the App Store version in Chrome Incognito mode (for onboarding/IAP testing).

    check_purity:
      run: ./scripts/purity_check.sh pocketcoder_foss
      description: Verify that the FOSS app has no proprietary dependencies.
    
    test:
      run: melos exec -- "flutter test"
      description: Run tests in all packages.

    fix:
      run: melos exec -- "dart fix --apply"
      description: Apply dart fixes to all packages.
