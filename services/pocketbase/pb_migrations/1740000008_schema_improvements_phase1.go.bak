package pb_migrations

import (
	"github.com/pocketbase/pocketbase/core"
	"github.com/pocketbase/pocketbase/migrations"
)

func init() {
	migrations.Register(func(app core.App) error {
		// =========================================================================
		// PHASE 1: CRITICAL FIXES
		// =========================================================================

		// 1. Rename agent_* fields to ai_engine_* and add engine_type
		// =========================================================================
		chats, err := app.FindCollectionByNameOrId("chats")
		if err != nil {
			return err
		}

		// Rename agent_id to ai_engine_session_id
		if field := chats.Fields.GetByName("agent_id"); field != nil {
			field.SetName("ai_engine_session_id")
		}

		// Add engine_type field
		if chats.Fields.GetByName("engine_type") == nil {
			chats.Fields.Add(&core.SelectField{
				Name:      "engine_type",
				MaxSelect: 1,
				Values:    []string{"opencode", "claude-code", "cursor", "custom"},
			})
		}

		// Add indexes for frequently filtered fields
		if len(chats.Indexes) == 0 {
			chats.Indexes = []string{}
		}
		chats.Indexes = append(chats.Indexes, "CREATE INDEX idx_chats_ai_engine_session_id ON chats (ai_engine_session_id)")

		if err := app.Save(chats); err != nil {
			return err
		}

		// 2. Rename message fields: agent_message_id, agent, provider_id, model_id
		// =========================================================================
		messages, err := app.FindCollectionByNameOrId("messages")
		if err != nil {
			return err
		}

		// Rename agent_message_id to ai_engine_message_id
		if field := messages.Fields.GetByName("agent_message_id"); field != nil {
			field.SetName("ai_engine_message_id")
		}

		// Rename agent to agent_name
		if field := messages.Fields.GetByName("agent"); field != nil {
			field.SetName("agent_name")
		}

		// Rename provider_id to provider_name
		if field := messages.Fields.GetByName("provider_id"); field != nil {
			field.SetName("provider_name")
		}

		// Rename model_id to model_name
		if field := messages.Fields.GetByName("model_id"); field != nil {
			field.SetName("model_name")
		}

		// Rename status to engine_message_status
		if field := messages.Fields.GetByName("status"); field != nil {
			field.SetName("engine_message_status")
			if selectField, ok := field.(*core.SelectField); ok {
				selectField.Values = []string{"processing", "completed", "failed", "aborted"}
			}
		}

		// Rename delivery to user_message_status
		if field := messages.Fields.GetByName("delivery"); field != nil {
			field.SetName("user_message_status")
			if selectField, ok := field.(*core.SelectField); ok {
				selectField.Values = []string{"pending", "sending", "delivered", "failed"}
			}
		}

		// Add index for frequently filtered field
		if len(messages.Indexes) == 0 {
			messages.Indexes = []string{}
		}
		messages.Indexes = append(messages.Indexes, "CREATE INDEX idx_messages_ai_engine_message_id ON messages (ai_engine_message_id)")

		if err := app.Save(messages); err != nil {
			return err
		}

		// 3. Rename permission fields: agent_permission_id
		// =========================================================================
		permissions, err := app.FindCollectionByNameOrId("permissions")
		if err != nil {
			return err
		}

		// Rename agent_permission_id to ai_engine_permission_id
		if field := permissions.Fields.GetByName("agent_permission_id"); field != nil {
			field.SetName("ai_engine_permission_id")
		}

		// Add audit fields
		if permissions.Fields.GetByName("approved_by") == nil {
			permissions.Fields.Add(&core.RelationField{
				Name:         "approved_by",
				CollectionId: "pb_users_auth_with_username", // users collection ID
				MaxSelect:    1,
			})
		}

		if permissions.Fields.GetByName("approved_at") == nil {
			permissions.Fields.Add(&core.DateField{Name: "approved_at"})
		}

		if err := app.Save(permissions); err != nil {
			return err
		}

		// 4. Fix subagents: restore chat relation and keep delegating_agent_id
		// =========================================================================
		subagents, err := app.FindCollectionByNameOrId("subagents")
		if err != nil {
			return err
		}

		// Add chat relation if missing
		if subagents.Fields.GetByName("chat") == nil {
			subagents.Fields.Add(&core.RelationField{
				Name:         "chat",
				CollectionId: chats.Id,
				MaxSelect:    1,
			})
		}

		// Add delegating_agent relation (in addition to delegating_agent_id string)
		if subagents.Fields.GetByName("delegating_agent") == nil {
			subagents.Fields.Add(&core.RelationField{
				Name:         "delegating_agent",
				CollectionId: "pc_ai_agents", // ai_agents collection ID
				MaxSelect:    1,
			})
		}

		if err := app.Save(subagents); err != nil {
			return err
		}

		// 5. Remove orphaned usages collection
		// =========================================================================
		usages, err := app.FindCollectionByNameOrId("usages")
		if err == nil {
			// Only delete if it exists and has no references
			if err := app.Delete(usages); err != nil {
				// Log but don't fail - usages might have data
				// return err
			}
		}

		return nil
	}, func(app core.App) error {
		// Down migration: revert all changes
		// Note: PocketBase doesn't support field removal, so we only revert renames

		// 1. Revert chats
		chats, err := app.FindCollectionByNameOrId("chats")
		if err != nil {
			return err
		}
		if field := chats.Fields.GetByName("ai_engine_session_id"); field != nil {
			field.SetName("agent_id")
		}
		if err := app.Save(chats); err != nil {
			return err
		}

		// 2. Revert messages
		messages, err := app.FindCollectionByNameOrId("messages")
		if err != nil {
			return err
		}
		if field := messages.Fields.GetByName("ai_engine_message_id"); field != nil {
			field.SetName("agent_message_id")
		}
		if field := messages.Fields.GetByName("agent_name"); field != nil {
			field.SetName("agent")
		}
		if field := messages.Fields.GetByName("provider_name"); field != nil {
			field.SetName("provider_id")
		}
		if field := messages.Fields.GetByName("model_name"); field != nil {
			field.SetName("model_id")
		}
		if field := messages.Fields.GetByName("engine_message_status"); field != nil {
			field.SetName("status")
			if selectField, ok := field.(*core.SelectField); ok {
				selectField.Values = []string{"processing", "completed", "failed", "aborted"}
			}
		}
		if field := messages.Fields.GetByName("user_message_status"); field != nil {
			field.SetName("delivery")
			if selectField, ok := field.(*core.SelectField); ok {
				selectField.Values = []string{"draft", "pending", "sending", "sent", "failed"}
			}
		}
		if err := app.Save(messages); err != nil {
			return err
		}

		// 3. Revert permissions
		permissions, err := app.FindCollectionByNameOrId("permissions")
		if err != nil {
			return err
		}
		if field := permissions.Fields.GetByName("ai_engine_permission_id"); field != nil {
			field.SetName("agent_permission_id")
		}
		if err := app.Save(permissions); err != nil {
			return err
		}

		// 4. Revert subagents (can't remove fields, so just revert renames)
		subagents, err := app.FindCollectionByNameOrId("subagents")
		if err != nil {
			return err
		}
		// Fields added in forward migration will remain (can't be removed)
		if err := app.Save(subagents); err != nil {
			return err
		}

		return nil
	})
}
