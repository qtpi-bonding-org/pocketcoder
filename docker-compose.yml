services:
  # ðŸ° POCKETBASE CORE (Backend Only)
  pocketbase:
    build:
      context: .
      dockerfile: docker/backend.Dockerfile
    container_name: pocketcoder-pocketbase
    ports:
      - "8090:8090" # PocketBase UI
    volumes:
      - pb_data:/app/pb_data
      - pocketcoder-logs:/app/pb_public/logs
      - opencode_workspace:/workspace
      - ./agents/poco/proposals:/workspace/.opencode/proposals
      - ./agents/poco/skills:/workspace/.opencode/skills
      - ./.ssh_keys:/ssh_keys
      - /var/run/docker.sock:/var/run/docker.sock
      - mcp_config:/mcp_config
    environment:
      - POCKETBASE_SUPERUSER_EMAIL=${POCKETBASE_SUPERUSER_EMAIL}
      - POCKETBASE_SUPERUSER_PASSWORD=${POCKETBASE_SUPERUSER_PASSWORD}
      - POCKETBASE_ADMIN_EMAIL=${POCKETBASE_ADMIN_EMAIL}
      - POCKETBASE_ADMIN_PASSWORD=${POCKETBASE_ADMIN_PASSWORD}
      - AGENT_EMAIL=${AGENT_EMAIL}
      - AGENT_PASSWORD=${AGENT_PASSWORD}
      - OPENCODE_URL=${OPENCODE_URL}
    command: >
      sh -c "echo 'â³ Waiting for OpenCode to be ready...' && while ! curl -I -s --connect-timeout 2 http://opencode:3000 > /dev/null; do echo 'OpenCode not yet ready, retrying in 1 second...' && sleep 1; done; echo 'ðŸš€ OpenCode is ready. Starting PocketBase...' && /app/pocketbase serve --http=0.0.0.0:8090"
    restart: unless-stopped
    networks:
      - pocketcoder-memory
      - pocketcoder-mcp

  # ðŸ§  OPENCODE (Reasoning Engine)
  opencode:
    build:
      context: .
      dockerfile: docker/opencode.Dockerfile
    container_name: pocketcoder-opencode
    environment:
      - PORT=3000
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GOOGLE_GENERATIVE_AI_API_KEY=${GEMINI_API_KEY}
      - PROXY_URL=http://sandbox:3001
      - SHELL=/shell_bridge/pocketcoder-shell
      - AGENT_EMAIL=${AGENT_EMAIL}
      - AGENT_PASSWORD=${AGENT_PASSWORD}
      - POCKETBASE_URL=http://pocketbase:8090
    working_dir: /workspace
    user: root
    volumes:
      - ./.ssh_keys:/ssh_keys:ro
      - shell_bridge:/shell_bridge:ro
      - opencode_workspace:/workspace
      - ./agents/poco/proposals:/workspace/.opencode/proposals
      - ./agents/poco/skills:/workspace/.opencode/skills:ro
      - opencode_data:/root/.local/share/opencode
      - ./opencode.json:/root/.config/opencode/opencode.json:ro
      - mcp_config:/mcp_config:ro
    command: serve --port 3000 --hostname 0.0.0.0 --log-level DEBUG
    healthcheck:
      test: ["CMD", "/bin/ash", "-c", "curl -f http://localhost:3000/health && nc -z localhost 2222"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped
    networks:
      - pocketcoder-memory
      - pocketcoder-control

  # ðŸ”¨ SANDBOX (Isolated Execution Environment)
  sandbox:
    build:
      context: .
      dockerfile: docker/sandbox.Dockerfile
    container_name: pocketcoder-sandbox
    volumes:
      - opencode_workspace:/workspace
      - ./agents/poco/proposals:/workspace/.opencode/proposals
      - ./agents/subagents:/root/.aws/cli-agent-orchestrator/agent-store
      - ./.ssh_keys:/ssh_keys:ro
      - shell_bridge:/app/shell_bridge
      - ./sandbox/cao/src:/app/cao/src
    working_dir: /workspace
    environment:
      - TMUX_TMPDIR=/tmp/tmux
      - TMUX_SOCKET=/tmp/tmux/pocketcoder
      - SSH_KEYS_FILE=/ssh_keys/authorized_keys
      - MCP_HOST=http://mcp-gateway:8811/sse
      - DOCKER_MCP_IN_CONTAINER=1
    networks:
      - pocketcoder-control
      - pocketcoder-mcp

  # ðŸ”Œ MCP GATEWAY (MCP Server Gateway)
  mcp-gateway:
    build:
      context: .
      dockerfile: docker/mcp-gateway.Dockerfile
    container_name: pocketcoder-mcp-gateway
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - mcp_config:/root/.docker/mcp
    environment:
      - DOCKER_MCP_IN_CONTAINER=1
    command: ["--port", "8811", "--transport", "sse", "--verbose", "--catalog", "/root/.docker/mcp/docker-mcp.yaml", "--enable-all-servers"]
    networks:
      - pocketcoder-mcp
    restart: unless-stopped

volumes:
  pb_data:
  pocketcoder-logs:
  opencode_workspace:
  sandbox_workspace:
  opencode_data:
  shell_bridge:
  mcp_config:

networks:
  pocketcoder-memory:
    driver: bridge
  pocketcoder-control:
    driver: bridge
  pocketcoder-mcp:
    driver: bridge