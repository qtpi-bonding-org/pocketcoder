services:
  # üè∞ POCKETBASE CORE (Backend Only)
  pocketbase:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pocketcoder-pocketbase
    ports:
      - "8090:8090" # PocketBase UI
    volumes:
      - pb_data:/app/pb_data
      - pocketcoder-logs:/app/pb_public/logs
    environment:
      - POCKETBASE_SUPERUSER_EMAIL=${POCKETBASE_SUPERUSER_EMAIL}
      - POCKETBASE_SUPERUSER_PASSWORD=${POCKETBASE_SUPERUSER_PASSWORD}
      - POCKETBASE_USER_EMAIL=${POCKETBASE_USER_EMAIL}
      - POCKETBASE_USER_PASSWORD=${POCKETBASE_USER_PASSWORD}
      - AGENT_EMAIL=${AGENT_EMAIL}
      - AGENT_PASSWORD=${AGENT_PASSWORD}
    restart: unless-stopped
    networks:
      - pocketcoder-memory

  # üåâ GATEWAY (Execution Bridge)
  gateway:
    build:
      context: .
      dockerfile: Dockerfile.gateway
    container_name: pocketcoder-gateway
    ports:
      - "3001:3001"
    volumes:
      - bridge_bin:/app/bridge_share        # Source for compiled bridge
      - tmux_socket:/tmp/tmux
    environment:
      - TMUX_TMPDIR=/tmp/tmux
      - TMUX_SOCKET=/tmp/tmux/pocketcoder
    restart: unless-stopped
    networks:
      pocketcoder-control:
        aliases:
          - gateway
      pocketcoder-execution:

  # üß† OPENCODE (Reasoning Engine)
  opencode:
    build:
      context: .
      dockerfile: Dockerfile.opencode
    container_name: pocketcoder-opencode
    volumes:
      - ./plugins/pocketcoder-plugin.ts:/pocketcoder-plugin.ts:ro
      - ./plugins/chat-plugin.ts:/chat-plugin.ts:ro
      - bridge_bin:/bridge:ro                                     # Read compiled bridge
      - workspace_data:/workspace                               # Shared Workspace
      - pocketcoder-logs:/logs                                  # Cold Pipe (Logs)
    environment:
      - PORT=3000
      - POCKETBASE_URL=http://pocketbase:8090
      - AGENT_EMAIL=${AGENT_EMAIL}
      - AGENT_PASSWORD=${AGENT_PASSWORD}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GOOGLE_GENERATIVE_AI_API_KEY=${GEMINI_API_KEY}
      - OPENCODE_CONFIG_CONTENT={"permission":{"*":"ask"},"model":"google/gemini-2.0-flash","plugin":["file:///pocketcoder-plugin.ts", "file:///chat-plugin.ts"],"mcp":{"pocketbase_mcp":{"type":"remote","url":"http://gateway:3001/sse","enabled":true},"cao_mcp":{"type":"remote","url":"http://sandbox:9889/mcp/sse","enabled":true}}}
      - SHELL=/bridge/pocketcoder-shell                        # THE BRIDGE
    working_dir: /workspace
    user: root
    entrypoint: /bin/sh
    command: >
      -c "
      echo 'üõ°Ô∏è Implementing Total Shell Hijack (Binary)...' &&
      ln -sf /bridge/pocketcoder-shell /bin/bash &&
      ln -sf /bridge/pocketcoder-shell /usr/bin/bash &&
      ln -sf /bridge/pocketcoder-shell /bin/sh &&
      echo 'üöÄ Starting OpenCode Serve...' &&
      exec opencode serve"
    ports:
      - "3000:3000"
    restart: unless-stopped
    networks:
      - pocketcoder-memory
      - pocketcoder-control

    depends_on:
      - pocketbase

  # üî® SANDBOX (Isolated Execution Environment)
  sandbox:
    build:
      context: .
      dockerfile: Dockerfile.sandbox
    container_name: pocketcoder-sandbox
    volumes:
      - workspace_data:/workspace   # Shared Workspace
      - tmux_socket:/tmp/tmux
    working_dir: /workspace
    environment:
      - TMUX_TMPDIR=/tmp/tmux
      - TMUX_SOCKET=/tmp/tmux/pocketcoder
    restart: unless-stopped
    networks:
      - pocketcoder-execution

volumes:
  pb_data:
  pocketcoder-logs:
  workspace_data:
  tmux_socket:
  bridge_bin:

networks:
  pocketcoder-memory:
    driver: bridge
  pocketcoder-control:
    driver: bridge
  pocketcoder-execution:
    driver: bridge
    # internal: true # Disabled to allow package installation (npm, pip)

