services:
  # ðŸ° POCKETBASE CORE (Backend Only)
  pocketbase:
    build:
      context: .
      dockerfile: services/pocketbase/Dockerfile
    container_name: pocketcoder-pocketbase
    ports:
      - "8090:8090" # PocketBase UI
    volumes:
      - pb_data:/app/pb_data
      # - pb_backups:/app/pb_backups
      - pocketcoder-logs:/app/pb_public/logs
      - opencode_workspace:/workspace
      - ./services/opencode:/workspace/.opencode
      - ./services/mcp-gateway/config:/mcp_config
    environment:
      - POCKETBASE_SUPERUSER_EMAIL=${POCKETBASE_SUPERUSER_EMAIL}
      - POCKETBASE_SUPERUSER_PASSWORD=${POCKETBASE_SUPERUSER_PASSWORD}
      - POCKETBASE_ADMIN_EMAIL=${POCKETBASE_ADMIN_EMAIL}
      - POCKETBASE_ADMIN_PASSWORD=${POCKETBASE_ADMIN_PASSWORD}
      - AGENT_EMAIL=${AGENT_EMAIL}
      - AGENT_PASSWORD=${AGENT_PASSWORD}
      - OPENCODE_URL=${OPENCODE_URL}
      - DOCKER_HOST=tcp://docker-socket-proxy-write:2375
    command: >
      sh -c "echo 'â³ Waiting for OpenCode to be ready...' && while ! curl -I -s --connect-timeout 2 http://opencode:3000 > /dev/null; do echo 'OpenCode not yet ready, retrying in 1 second...' && sleep 1; done; echo 'ðŸš€ OpenCode is ready. Starting PocketBase...' && /app/pocketbase serve --http=0.0.0.0:8090"
    restart: unless-stopped
    networks:
      - pocketcoder-dashboard
      - pocketcoder-docker
      - pocketcoder-relay

  # ðŸ§  OPENCODE (Reasoning Engine)
  opencode:
    build:
      context: .
      dockerfile: services/opencode/Dockerfile
    container_name: pocketcoder-opencode
    depends_on:
      sandbox:
        condition: service_healthy
    environment:
      - PORT=3000
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GOOGLE_GENERATIVE_AI_API_KEY=${GEMINI_API_KEY}
      - PROXY_URL=http://sandbox:3001
      - SHELL=/usr/local/bin/pocketcoder-shell
      - AGENT_EMAIL=${AGENT_EMAIL}
      - AGENT_PASSWORD=${AGENT_PASSWORD}
      - POCKETBASE_URL=http://pocketbase:8090
    working_dir: /workspace
    user: root
    volumes:
      - opencode_workspace:/workspace
      - ./services/opencode:/workspace/.opencode
      - opencode_data:/root/.local/share/opencode
      - ./opencode.json:/root/.config/opencode/opencode.json:ro
      - ./services/mcp-gateway/config:/mcp_config:ro
      - shell_bridge:/shell_bridge
    command: serve --port 3000 --hostname 0.0.0.0 --log-level DEBUG
    healthcheck:
      test: ["CMD", "/bin/ash", "-c", "curl -f http://localhost:3000/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped
    networks:
      - pocketcoder-relay
      - pocketcoder-control

  # ðŸ”¨ SANDBOX (Isolated Execution Environment)
  sandbox:
    build:
      context: .
      dockerfile: services/sandbox/Dockerfile
    container_name: pocketcoder-sandbox
    volumes:
      - opencode_workspace:/workspace
      - ./services/opencode:/workspace/.opencode
      - ./agents/subagents:/root/.aws/cli-agent-orchestrator/agent-store
      - cao_db:/root/.aws/cli-agent-orchestrator/db  # CAO SQLite database
      - ./services/sandbox/cao/src:/app/cao/src
      - ./services/sandbox/opencode.json:/root/.config/opencode/opencode.json:ro
      - shell_bridge:/app/shell_bridge
    working_dir: /workspace
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GOOGLE_GENERATIVE_AI_API_KEY=${GEMINI_API_KEY}
      - TMUX_TMPDIR=/tmp/tmux
      - TMUX_SOCKET=/tmp/tmux/pocketcoder
      - MCP_HOST=http://mcp-gateway:8811/sse
      - OPENCODE_URL=http://opencode:3000
      - DOCKER_MCP_IN_CONTAINER=1
    healthcheck:
      test: ["CMD", "/bin/bash", "-c", "curl -f http://localhost:3001/health && curl -f http://localhost:9889/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - pocketcoder-control
      - pocketcoder-tools

  # ðŸ”Œ MCP GATEWAY (MCP Server Gateway)
  mcp-gateway:
    build:
      context: .
      dockerfile: services/mcp-gateway/Dockerfile
    container_name: pocketcoder-mcp-gateway
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./services/mcp-gateway/config:/root/.docker/mcp
    environment:
      - DOCKER_MCP_IN_CONTAINER=1
      - LINODE_TOKEN=${LINODE_TOKEN}
      - ENABLE_TF_OPERATIONS=${ENABLE_TF_OPERATIONS}
      - TFE_TOKEN=${TFE_TOKEN}
      - DOCKER_MCP_TELEMETRY_DEBUG=1
    command: ["--port", "8811", "--transport", "sse", "--verbose", "--log-calls", "--log", "/var/log/mcp-gateway.log", "--catalog", "/root/.docker/mcp/docker-mcp.yaml", "--enable-all-servers"]
    networks:
      - pocketcoder-docker
      - pocketcoder-tools
    restart: unless-stopped

  # ðŸ”’ DOCKER SOCKET PROXY - WRITE (Security Layer for PocketBase)
  # Currently shared by both PocketBase (restart) and Dozzle (logs)
  # For production: uncomment docker-socket-proxy-read below and update Dozzle config
  docker-socket-proxy-write:
    image: tecnativa/docker-socket-proxy:latest
    container_name: pocketcoder-docker-proxy-write
    environment:
      # Enable container operations for PocketBase restart capability
      - CONTAINERS=1          # Allow container operations (list, inspect, restart)
      - POST=1                # Allow POST requests (for restart)
      - EVENTS=1              # Allow streaming events (for Dozzle)
      - INFO=1                # Required for Dozzle to detect Docker version
      - IMAGES=0              # Disable image operations
      - NETWORKS=0            # Disable network operations
      - VOLUMES=0             # Disable volume operations
      - BUILD=0               # Disable build operations
      - COMMIT=0              # Disable commit operations
      - CONFIGS=0             # Disable config operations
      - DISTRIBUTION=0        # Disable distribution operations
      - EXEC=0                # Disable exec operations
      - PLUGINS=0             # Disable plugin operations
      - SECRETS=0             # Disable secrets operations
      - SERVICES=0            # Disable services operations
      - SESSION=0             # Disable session operations
      - SWARM=0               # Disable swarm operations
      - SYSTEM=0              # Disable system operations
      - TASKS=0               # Disable tasks operations
      - LOG_LEVEL=info        # Logging level
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - pocketcoder-docker
    restart: unless-stopped

  # ðŸ“ˆ SQLPAGE (SQLite Dashboard)
  sqlpage:
    image: lovasoa/sqlpage:latest
    user: root
    container_name: pocketcoder-sqlpage
    environment:
      - SQLPAGE_ENVIRONMENT=development
      - SQLPAGE_SITE_PREFIX=/api/pocketcoder/proxy/observability/
    volumes:
      - pb_data:/database/pocketbase           # PocketBase DB (operational)
      - opencode_data:/database/opencode       # OpenCode DB (analytics)
      - cao_db:/database/cao                   # CAO DB (subagent tasks)
      - ./services/sqlpage/dashboard:/var/www:ro                  # SQLPage queries/dashboards
      - ./services/sqlpage/config:/etc/sqlpage:ro       # Configuration (sqlpage.json, on_connect.sql)
    networks:
      - pocketcoder-dashboard
    restart: unless-stopped
    depends_on:
      - pocketbase
      - opencode
      - sandbox

  # ðŸ“š DOCS (Documentation Site)
  docs:
    build:
      context: .
      dockerfile: services/docs/Dockerfile
    container_name: pocketcoder-docs
    ports:
      - "4321:4321"
    volumes:
      - ./services/docs:/app/docs
      - /app/docs/node_modules  # Don't mount node_modules - use container's installed version
      - ./services/pocketbase:/app/pocketbase
      - ./proxy:/app/proxy
      - ./DEVELOPMENT.md:/app/DEVELOPMENT.md:ro
      - ./SECURITY.md:/app/SECURITY.md:ro
      - ./scripts:/app/scripts:ro
    working_dir: /app/docs
    environment:
      - NODE_ENV=development
    command: /bin/bash -c "./sync.sh && npm run dev -- --host 0.0.0.0"
    restart: unless-stopped
    networks:
      - pocketcoder-dashboard

volumes:
  pb_data:
  # pb_backups:
  #   external: true
  #   name: pocketcoder_pb_backups
  pocketcoder-logs:
  opencode_workspace:
  opencode_data:
  cao_db:  # CAO SQLite database for subagent tasks
  shell_bridge:

networks:
  pocketcoder-dashboard:
    driver: bridge
  pocketcoder-control:
    driver: bridge
  pocketcoder-docker:
    driver: bridge
  pocketcoder-relay:
    driver: bridge
  pocketcoder-tools:
    driver: bridge