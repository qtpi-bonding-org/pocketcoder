services:
  # ðŸ° POCKETBASE CORE (Backend Only)
  pocketbase:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pocketcoder-pocketbase
    ports:
      - "8090:8090" # PocketBase UI
    volumes:
      - pb_data:/app/pb_data
      - pocketcoder-logs:/app/pb_public/logs
      - workspace_data:/workspace
      - ./proposals:/workspace/.opencode/proposals
      - ./skills:/workspace/.opencode/skills
    environment:
      - POCKETBASE_SUPERUSER_EMAIL=${POCKETBASE_SUPERUSER_EMAIL}
      - POCKETBASE_SUPERUSER_PASSWORD=${POCKETBASE_SUPERUSER_PASSWORD}
      - POCKETBASE_ADMIN_EMAIL=${POCKETBASE_ADMIN_EMAIL}
      - POCKETBASE_ADMIN_PASSWORD=${POCKETBASE_ADMIN_PASSWORD}
      - AGENT_EMAIL=${AGENT_EMAIL}
      - AGENT_PASSWORD=${AGENT_PASSWORD}
      - OPENCODE_URL=${OPENCODE_URL}
    command: >
      sh -c "echo 'â³ Waiting for OpenCode to be ready...' && while ! curl -I -s --connect-timeout 2 http://opencode:3000 > /dev/null; do echo 'OpenCode not yet ready, retrying in 1 second...' && sleep 1; done; echo 'ðŸš€ OpenCode is ready. Starting PocketBase...' && /app/entrypoint.sh"
    restart: unless-stopped
    networks:
      - pocketcoder-memory

  # ðŸ° PROXY (Execution Relay)
  proxy:
    build:
      context: .
      dockerfile: Dockerfile.proxy
    container_name: pocketcoder-proxy
    volumes:
      - proxy_bin:/app/proxy_share
      - tmux_socket:/tmp/tmux
      - ./.ssh_keys:/ssh_keys:ro          # Mount local keys read-only
    environment:
      - TMUX_TMPDIR=/tmp/tmux
      - TMUX_SOCKET=/tmp/tmux/pocketcoder
    restart: unless-stopped
    networks:
      pocketcoder-control:
        aliases:
          - proxy
      pocketcoder-execution:
        aliases:
          - proxy

  # ðŸ§  OPENCODE (Reasoning Engine)
  opencode:
    build:
      context: .
      dockerfile: Dockerfile.opencode
    container_name: pocketcoder-opencode
    environment:
      - PORT=3000
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GOOGLE_GENERATIVE_AI_API_KEY=${GEMINI_API_KEY}
      - SHELL=/proxy/pocketcoder-shell                        # THE PROXY
    working_dir: /workspace
    user: root
    volumes:
      - proxy_bin:/proxy:ro                                     # Read compiled proxy
      - workspace_data:/workspace                               # Shared Workspace
      - ./proposals:/workspace/.opencode/proposals
      - ./skills:/workspace/.opencode/skills:ro
      - opencode_data:/root/.local/share/opencode              # Persistent Storage
      - ./opencode.json:/root/.config/opencode/opencode.json:ro
    entrypoint: /bin/sh
    command: >
      -c "
      echo 'â³ Waiting for PocketCoder Shell...' &&
      while [ ! -f /proxy/pocketcoder-shell ]; do sleep 1; done &&
      echo 'â³ Waiting for Proxy Server...' &&
      while ! curl -s http://proxy:3001/health > /dev/null; do sleep 1; done &&
      echo 'ðŸš€ Starting OpenCode Serve...' &&
      exec /bin/sh -c 'opencode serve --port 3000 --hostname 0.0.0.0 --log-level DEBUG'"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - pocketcoder-memory
      - pocketcoder-control




  # ðŸ”¨ SANDBOX (Isolated Execution Environment)
  sandbox:
    build:
      context: .
      dockerfile: Dockerfile.sandbox
    container_name: pocketcoder-sandbox
    volumes:
      - workspace_data:/workspace   # Shared Workspace
      - ./proposals:/workspace/.opencode/proposals
      - tmux_socket:/tmp/tmux
      - ./.ssh_keys:/ssh_keys:ro  # Read-only access to local SSH keys
      - ./sandbox/cao/src:/app/cao/src                          # Mount ONLY src for live-editing
    working_dir: /workspace
    environment:
      - TMUX_TMPDIR=/tmp/tmux
      - TMUX_SOCKET=/tmp/tmux/pocketcoder
      - SSH_KEYS_FILE=/ssh_keys/authorized_keys
    networks:
      - pocketcoder-execution


volumes:
  pb_data:
  pocketcoder-logs:
  workspace_data:
  opencode_data:
  tmux_socket:
  proxy_bin:

networks:
  pocketcoder-memory:
    driver: bridge
  pocketcoder-control:
    driver: bridge
  pocketcoder-execution:
    driver: bridge
    # internal: true # Disabled to allow package installation (npm, pip)

