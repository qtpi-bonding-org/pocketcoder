---
title: Relay Reference
---

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

*   [PocketBase][1]
*   [listenForPermissions][2]
*   [listenForPermissions][3]
*   [handlePermissionAsked][4]
    *   [Parameters][5]
*   [subscribeToAgentUpdates][6]
*   [ensureOpencodeSession][7]
    *   [Parameters][8]
*   [processUserMessage][9]
    *   [Parameters][10]
*   [pollOpenCodeResponse][11]
    *   [Parameters][12]
*   [saveAssistantResponse][13]
    *   [Parameters][14]
*   [start][15]

## PocketBase

ğŸŒ‰ POCKETCODER CHAT RELAY (SDK VERSION)

This service relays between PocketBase and OpenCode using the PocketBase JS SDK:

1.  Subscribes to new user messages in PocketBase (Realtime)
2.  Catches up on missed messages on startup (Recovery)
3.  Sends them to OpenCode via REST API
4.  Streams responses back to PocketBase for the UI

## listenForPermissions

ğŸ›¡ï¸ GATEKEEPER: Sync Permissions

## listenForPermissions

ğŸ‘‚ listenForPermissions
Connects to the OpenCode Server-Sent Events (SSE) stream.
Listens for 'permission.asked' events and triggers the Gatekeeper flow.

## handlePermissionAsked

ğŸ›¡ï¸ handlePermissionAsked
The entry point for the "Sovereign Authority" flow.

1.  Resolves the Chat ID from the OpenCode Session ID.
2.  POSTs the intent to the PocketBase /api/pocketcoder/permission endpoint.
3.  Acts on the decision (Auto-Authorize or Manual Gate).

### Parameters

*   `payload` **[Object][16]** The permission request payload from OpenCode.

## subscribeToAgentUpdates

ğŸ¤– AI REGISTRY: Deploy Agents

## ensureOpencodeSession

Get or create OpenCode session for a specific chat

### Parameters

*   `chatId` &#x20;

## processUserMessage

Handle a new user message

### Parameters

*   `msg` &#x20;

## pollOpenCodeResponse

Poll OpenCode for response and sync back to PocketBase

### Parameters

*   `sessionId` &#x20;
*   `opencodeMsgId` &#x20;
*   `pbChatId` &#x20;

## saveAssistantResponse

Save assistant message to PocketBase

### Parameters

*   `chatId` &#x20;
*   `opencodeMessage` &#x20;

## start

Main Loop

[1]: #pocketbase

[2]: #listenforpermissions

[3]: #listenforpermissions-1

[4]: #handlepermissionasked

[5]: #parameters

[6]: #subscribetoagentupdates

[7]: #ensureopencodesession

[8]: #parameters-1

[9]: #processusermessage

[10]: #parameters-2

[11]: #pollopencoderesponse

[12]: #parameters-3

[13]: #saveassistantresponse

[14]: #parameters-4

[15]: #start

[16]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object


**Lines of Code:** 708
